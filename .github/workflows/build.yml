# Tên của workflow
name: Build & Release (Theo Tag)

# Kích hoạt workflow khi:
on:
  # Kịch bản 1: Kích hoạt khi push một tag mới có dạng 'v*' (ví dụ: v0.7.0)
  push:
    tags:
      - 'v*'
      
  # Kịch bản 2: Kích hoạt thủ công (bằng nút "Run workflow")
  workflow_dispatch:
    # Thêm 'inputs' để cho phép người dùng nhập tag giả lập khi test
    inputs:
      simulated_tag:
        description: 'Nhập tag giả lập (ví dụ: v0.0.1-test) để test build'
        required: true
        default: 'v0.0.1-test'

jobs:
  build-release:
    name: Build cho ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    environment: builder
    
    strategy:
      # Tắt fail-fast để một OS lỗi không làm hỏng các OS khác
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]

    steps:
      # 1. Checkout code
      - name: Lấy mã nguồn (Checkout)
        uses: actions/checkout@v4

      # 2. Lấy version (Hỗ trợ cả tag thật và test thủ công)
      - name: Lấy Version
        id: get_version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            VERSION="${{ github.ref_name }}"
            echo "Chạy với tag thật: $VERSION"
          else
            VERSION="${{ github.event.inputs.simulated_tag }}"
            echo "Chạy thủ công với tag giả lập: $VERSION"
          fi
          
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          
          VERSION_NUMBER="${VERSION#v}"
          echo "VERSION_NUMBER=$VERSION_NUMBER" >> $GITHUB_OUTPUT

      # 3. Cài đặt môi trường Bun
      - name: Cài đặt Bun
        uses: oven-sh/setup-bun@v1

      # 4. Cài đặt dependencies
      - name: Cài đặt dependencies
        run: bun install --frozen-lockfile

      # 5. Build file binary dựa trên OS
      - name: Build Binary
        id: build
        shell: bash
        run: |
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            echo "Đang build cho Windows..."
            bun run build-win
            echo "binary-path=dist/tp.exe" >> $GITHUB_OUTPUT
            echo "artifact-name=tp-windows.exe" >> $GITHUB_OUTPUT
            echo "iss-output-name=TeaserPaste_CLI_Setup-${{ steps.get_version.outputs.VERSION_NUMBER }}.exe" >> $GITHUB_OUTPUT
            # Tên file cuối cùng theo phiên bản (dùng để upload)
            echo "upload-file-name=TeaserPaste_CLI_Setup-${{ steps.get_version.outputs.VERSION_NUMBER }}.exe" >> $GITHUB_OUTPUT
          
          elif [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            echo "Đang build cho Linux..."
            bun run build-linux
            echo "binary-path=dist/tp-linux" >> $GITHUB_OUTPUT
            echo "artifact-name=tp-linux" >> $GITHUB_OUTPUT
            echo "upload-file-name=tp-cli_${{ steps.get_version.outputs.VERSION_NUMBER }}_amd64.deb" >> $GITHUB_OUTPUT
          
          elif [ "${{ matrix.os }}" = "macos-latest" ]; then
            echo "Đang build cho macOS..."
            bun run build-mac
            echo "binary-path=dist/tp-macos" >> $GITHUB_OUTPUT
            echo "artifact-name=tp-macos" >> $GITHUB_OUTPUT
            echo "upload-file-name=tp-cli-${{ steps.get_version.outputs.VERSION_NUMBER }}.dmg" >> $GITHUB_OUTPUT
          fi

      # 6. Upload file binary thô (artifact)
      - name: Upload Binary Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build.outputs.artifact-name }}
          path: ${{ steps.build.outputs.binary-path }}
          if-no-files-found: error

      # 7. [CHỈ WINDOWS] Biên dịch file cài đặt Inno Setup
      - name: Biên dịch Inno Setup Installer
        if: matrix.os == 'windows-latest'
        uses: Minionguyjpro/Inno-Setup-Action@v1.2.7
        with:
          path: TeaserPasteCLI.iss
          
      # 8. [CHỈ LINUX] Tạo gói .deb
      - name: Tạo gói .deb (Linux)
        if: matrix.os == 'ubuntu-latest'
        id: package_deb
        shell: bash
        run: |
          DEB_NAME="${{ steps.build.outputs.upload-file-name }}"
          echo "deb-name=${DEB_NAME}" >> $GITHUB_OUTPUT
          mkdir -p package/DEBIAN
          mkdir -p package/usr/bin
          cp ${{ steps.build.outputs.binary-path }} package/usr/bin/tp
          cat <<EOF > package/DEBIAN/control
          Package: tp-cli
          Version: ${{ steps.get_version.outputs.VERSION_NUMBER }}
          Section: utils
          Priority: optional
          Architecture: amd64
          Maintainer: TeaserPaste <contact@teaserverse.online>
          Description: TeaserPaste CLI (tp)
           Một công cụ dòng lệnh nhanh để tương tác với TeaserPaste.
          EOF
          chmod +x package/usr/bin/tp
          dpkg-deb --build package
          mv package.deb ${DEB_NAME}

      # 9. [CHỈ LINUX] Kiểm tra (sanity check) file .deb
      - name: Kiểm tra (sanity check) file .deb
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          echo "Đang kiểm tra metadata của file .deb..."
          dpkg-deb -I ${{ steps.package_deb.outputs.deb-name }} | grep "Package: tp-cli"
          dpkg-deb -I ${{ steps.package_deb.outputs.deb-name }} | grep "Version: ${{ steps.get_version.outputs.VERSION_NUMBER }}"
          echo "Đang kiểm tra nội dung file .deb..."
          dpkg-deb -c ${{ steps.package_deb.outputs.deb-name }} | grep "usr/bin/tp"
          echo "Kiểm tra .deb hoàn tất."
          
      # 10. [CHỈ MACOS] Tạo gói .dmg (Dùng UDZO nén)
      - name: Tạo gói .dmg (macOS)
        if: matrix.os == 'macos-latest'
        id: package_dmg
        shell: bash
        run: |
          DMG_NAME="${{ steps.build.outputs.upload-file-name }}"
          VOL_NAME="TeaserPaste CLI ${{ steps.get_version.outputs.VERSION_NUMBER }}"
          echo "dmg-name=${DMG_NAME}" >> $GITHUB_OUTPUT
          
          mkdir -p staging
          cp ${{ steps.build.outputs.binary-path }} staging/tp
          chmod +x staging/tp
          
          echo "Đang tạo DMG nén..."
          hdiutil create -volname "${VOL_NAME}" -srcfolder staging -ov -format UDZO "${DMG_NAME}"

      # 11. [CHỈ MACOS] Kiểm tra (sanity check) file .dmg (Chỉ Verify)
      - name: Kiểm tra (sanity check) file .dmg
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          echo "Đang kiểm tra tính toàn vẹn (verify) của file .dmg..."
          hdiutil verify ${{ steps.package_dmg.outputs.dmg-name }}
          echo "Kiểm tra .dmg hoàn tất."
          
      # 12. [CHỈ WINDOWS] Upload file cài đặt .exe làm artifact
      - name: Upload Installer Artifact
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: TeaserPaste_CLI_Setup-${{ steps.get_version.outputs.VERSION }}.exe
          path: Output/${{ steps.build.outputs.iss-output-name }}
          if-no-files-found: error
          
      # 13. [CHỈ LINUX] Upload file .deb làm artifact
      - name: Upload Linux .deb Artifact
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: tp-linux-deb-${{ steps.get_version.outputs.VERSION }}
          path: ${{ steps.package_deb.outputs.deb-name }}
          if-no-files-found: error

      # 14. [CHỈ MACOS] Upload file .dmg làm artifact
      - name: Upload macOS .dmg Artifact
        if: matrix.os == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: tp-macos-dmg-${{ steps.get_version.outputs.VERSION }}
          path: ${{ steps.package_dmg.outputs.dmg-name }}
          if-no-files-found: error
          
      # --- UPLOAD CÁC FILE CÓ ĐÁNH SỐ PHIÊN BẢN (Ví dụ: tp-cli_0.0.1-test_amd64.deb) ---
      # Bước này dùng source-file và destination-file, nhưng đây là R2-action khác
      # do action ryand56 không hỗ trợ source-file/destination-file như ý muốn
      # Chúng ta sẽ sử dụng action 'source-dir' và 'destination-dir' để upload file theo tên phiên bản
      
      # 15. Upload file có phiên bản (Ví dụ: TeaserPaste_CLI_Setup-0.0.1-test.exe)
      - name: Upload Versioned Files to R2
        uses: ryand56/r2-upload-action@v1.4
        id: upload_versioned
        with:
          r2-account-id: ${{ secrets.R2_ACCOUNT_ID }}
          r2-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID }}
          r2-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          r2-bucket: ${{ secrets.R2_BUCKET_NAME }}
          source-dir: ${{ matrix.os == 'windows-latest' && 'Output' || '.' }}
          destination-dir: /releases/${{ steps.get_version.outputs.VERSION_NUMBER }}
          include: ${{ steps.build.outputs.upload-file-name }}
          
      # --- TẠO ALIAS 'LATEST' (Đổi tên file đã upload) ---
      # Thao tác này dùng cURL và AWS CLI (có sẵn trên runner) để đổi tên file đã upload
      
      # 16. Đặt ALIAS 'LATEST' (Windows)
      - name: Đặt ALIAS 'LATEST' cho Windows
        if: matrix.os == 'windows-latest'
        shell: bash
        run: |
          source_key="releases/${{ steps.get_version.outputs.VERSION_NUMBER }}/${{ steps.build.outputs.upload-file-name }}"
          target_key="teaserpaste-cli-latest-setup.exe"
          
          aws s3 cp s3://${{ secrets.R2_BUCKET_NAME }}/${source_key} \
              s3://${{ secrets.R2_BUCKET_NAME }}/${target_key} \
              --endpoint-url "https://${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com" \
              --copy-source-if-match "*" \
              --recursive

      # 17. Đặt ALIAS 'LATEST' (Linux)
      - name: Đặt ALIAS 'LATEST' cho Linux
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          source_key="releases/${{ steps.get_version.outputs.VERSION_NUMBER }}/${{ steps.build.outputs.upload-file-name }}"
          target_key="teaserpaste-cli-latest.deb"
          
          aws s3 cp s3://${{ secrets.R2_BUCKET_NAME }}/${source_key} \
              s3://${{ secrets.R2_BUCKET_NAME }}/${target_key} \
              --endpoint-url "https://${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com" \
              --copy-source-if-match "*" \
              --recursive
              
      # 18. Đặt ALIAS 'LATEST' (macOS)
      - name: Đặt ALIAS 'LATEST' cho macOS
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          source_key="releases/${{ steps.get_version.outputs.VERSION_NUMBER }}/${{ steps.build.outputs.upload-file-name }}"
          target_key="teaserpaste-cli-latest.dmg"
          
          aws s3 cp s3://${{ secrets.R2_BUCKET_NAME }}/${source_key} \
              s3://${{ secrets.R2_BUCKET_NAME }}/${target_key} \
              --endpoint-url "https://${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com" \
              --copy-source-if-match "*" \
              --recursive
