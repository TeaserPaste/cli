# Tên của workflow
name: Build & Release (Theo Tag)

# Kích hoạt workflow khi:
on:
  # Kịch bản 1: Kích hoạt khi push một tag mới có dạng 'v*' (ví dụ: v0.7.0)
  push:
    tags:
      - 'v*'
      
  # Kịch bản 2: Kích hoạt thủ công (bằng nút "Run workflow")
  workflow_dispatch:
    # Thêm 'inputs' để cho phép người dùng nhập tag giả lập khi test
    inputs:
      simulated_tag:
        description: 'Nhập tag giả lập (ví dụ: v0.0.1-test) để test build'
        required: true
        default: 'v0.0.1-test'

jobs:
  build-release:
    name: Build cho ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    environment: builder
    
    strategy:
      # Tắt fail-fast để một OS lỗi không làm hỏng các OS khác
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]

    steps:
      # 1. Checkout code
      - name: Lấy mã nguồn (Checkout)
        uses: actions/checkout@v4

      # 2. Lấy version (Hỗ trợ cả tag thật và test thủ công)
      - name: Lấy Version
        id: get_version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            VERSION="${{ github.ref_name }}"
            echo "Chạy với tag thật: $VERSION"
          else
            VERSION="${{ github.event.inputs.simulated_tag }}"
            echo "Chạy thủ công với tag giả lập: $VERSION"
          fi
          
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          
          VERSION_NUMBER="${VERSION#v}"
          echo "VERSION_NUMBER=$VERSION_NUMBER" >> $GITHUB_OUTPUT

      # 3. Cài đặt môi trường Bun
      - name: Cài đặt Bun
        uses: oven-sh/setup-bun@v1

      # 4. Cài đặt dependencies
      - name: Cài đặt dependencies
        run: bun install --frozen-lockfile

      # 5. Build file binary dựa trên OS
      - name: Build Binary
        id: build
        shell: bash
        run: |
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            echo "Đang build cho Windows..."
            bun run build-win
            echo "binary-path=dist/tp.exe" >> $GITHUB_OUTPUT
            echo "artifact-name=tp-windows.exe" >> $GITHUB_OUTPUT
            echo "iss-output-name=TeaserPaste_CLI_Setup-${{ steps.get_version.outputs.VERSION_NUMBER }}.exe" >> $GITHUB_OUTPUT
          
          elif [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            echo "Đang build cho Linux..."
            bun run build-linux
            echo "binary-path=dist/tp-linux" >> $GITHUB_OUTPUT
            echo "artifact-name=tp-linux" >> $GITHUB_OUTPUT
          
          elif [ "${{ matrix.os }}" = "macos-latest" ]; then
            echo "Đang build cho macOS..."
            bun run build-mac
            echo "binary-path=dist/tp-macos" >> $GITHUB_OUTPUT
            echo "artifact-name=tp-macos" >> $GITHUB_OUTPUT
          fi

      # 6. Upload file binary thô (artifact)
      - name: Upload Binary Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build.outputs.artifact-name }}
          path: ${{ steps.build.outputs.binary-path }}
          if-no-files-found: error

      # 7. [CHỈ WINDOWS] Biên dịch file cài đặt Inno Setup
      - name: Biên dịch Inno Setup Installer
        if: matrix.os == 'windows-latest'
        id: compile_iss
        uses: Minionguyjpro/Inno-Setup-Action@v1.2.7
        with:
          path: TeaserPasteCLI.iss
          
      # 8. [CHỈ LINUX] Tạo gói .deb
      - name: Tạo gói .deb (Linux)
        if: matrix.os == 'ubuntu-latest'
        id: package_deb
        shell: bash
        run: |
          DEB_NAME="tp-cli_${{ steps.get_version.outputs.VERSION_NUMBER }}_amd64.deb"
          echo "deb-name=${DEB_NAME}" >> $GITHUB_OUTPUT
          mkdir -p package/DEBIAN
          mkdir -p package/usr/bin
          cp ${{ steps.build.outputs.binary-path }} package/usr/bin/tp
          cat <<EOF > package/DEBIAN/control
          Package: tp-cli
          Version: ${{ steps.get_version.outputs.VERSION_NUMBER }}
          Section: utils
          Priority: optional
          Architecture: amd64
          Maintainer: TeaserPaste <contact@teaserverse.online>
          Description: TeaserPaste CLI (tp)
           Một công cụ dòng lệnh nhanh để tương tác với TeaserPaste.
          EOF
          chmod +x package/usr/bin/tp
          dpkg-deb --build package
          mv package.deb ${DEB_NAME}

      # 9. [CHỈ LINUX] Kiểm tra (sanity check) file .deb
      - name: Kiểm tra (sanity check) file .deb
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          echo "Đang kiểm tra metadata của file .deb..."
          dpkg-deb -I ${{ steps.package_deb.outputs.deb-name }} | grep "Package: tp-cli"
          dpkg-deb -I ${{ steps.package_deb.outputs.deb-name }} | grep "Version: ${{ steps.get_version.outputs.VERSION_NUMBER }}"
          echo "Đang kiểm tra nội dung file .deb..."
          dpkg-deb -c ${{ steps.package_deb.outputs.deb-name }} | grep "usr/bin/tp"
          echo "Kiểm tra .deb hoàn tất."
          
      # 10. [CHỈ MACOS] Tạo gói .dmg (Dùng UDZO nén)
      - name: Tạo gói .dmg (macOS)
        if: matrix.os == 'macos-latest'
        id: package_dmg
        shell: bash
        run: |
          DMG_NAME="tp-cli-${{ steps.get_version.outputs.VERSION_NUMBER }}.dmg"
          VOL_NAME="TeaserPaste CLI ${{ steps.get_version.outputs.VERSION_NUMBER }}"
          echo "dmg-name=${DMG_NAME}" >> $GITHUB_OUTPUT
          
          mkdir -p staging
          cp ${{ steps.build.outputs.binary-path }} staging/tp
          chmod +x staging/tp
          
          echo "Đang tạo DMG nén..."
          hdiutil create -volname "${VOL_NAME}" -srcfolder staging -ov -format UDZO "${DMG_NAME}"

      # 11. [CHỈ MACOS] Kiểm tra (sanity check) file .dmg (Chỉ Verify)
      - name: Kiểm tra (sanity check) file .dmg
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          echo "Đang kiểm tra tính toàn vẹn (verify) của file .dmg..."
          hdiutil verify ${{ steps.package_dmg.outputs.dmg-name }}
          echo "Kiểm tra .dmg hoàn tất."
          
      # 12. [CHỈ WINDOWS] Upload file cài đặt .exe làm artifact
      - name: Upload Installer Artifact
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: TeaserPaste_CLI_Setup-${{ steps.get_version.outputs.VERSION }}.exe
          path: Output/${{ steps.build.outputs.iss-output-name }}
          if-no-files-found: error
          
      # 13. [CHỈ LINUX] Upload file .deb làm artifact
      - name: Upload Linux .deb Artifact
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: tp-linux-deb-${{ steps.get_version.outputs.VERSION }}
          path: ${{ steps.package_deb.outputs.deb-name }}
          if-no-files-found: error

      # 14. [CHỈ MACOS] Upload file .dmg làm artifact
      - name: Upload macOS .dmg Artifact
        if: matrix.os == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: tp-macos-dmg-${{ steps.get_version.outputs.VERSION }}
          path: ${{ steps.package_dmg.outputs.dmg-name }}
          if-no-files-found: error
          
      # --- UPLOAD VÀ ĐỔI TÊN THÀNH 'LATEST' CHO WINDOWS ---
      - name: Chuẩn bị file Windows cho R2
        id: prepare_win_r2
        if: matrix.os == 'windows-latest'
        shell: bash
        run: |
          # 1. Định nghĩa tên file gốc và file đích
          ORIGINAL_FILE="Output/${{ steps.build.outputs.iss-output-name }}"
          TARGET_DIR="r2_upload"
          TARGET_FILE="teaserpaste-cli-latest-setup.exe"
          
          # 2. Tạo thư mục tạm và di chuyển file, đồng thời đổi tên thành 'latest'
          mkdir -p $TARGET_DIR
          mv $ORIGINAL_FILE $TARGET_DIR/$TARGET_FILE
          echo "::set-output name=r2_source_dir::$TARGET_DIR"
          
      - name: Upload 'latest' (Windows) lên R2
        if: matrix.os == 'windows-latest'
        uses: ryand56/r2-upload-action@v1.4
        with:
          r2-account-id: ${{ secrets.R2_ACCOUNT_ID }}
          r2-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID }}
          r2-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          r2-bucket: ${{ secrets.R2_BUCKET_NAME }}
          source-dir: ${{ steps.prepare_win_r2.outputs.r2_source_dir }}
          destination-dir: /

      # --- UPLOAD VÀ ĐỔI TÊN THÀNH 'LATEST' CHO LINUX ---
      - name: Chuẩn bị file Linux cho R2
        id: prepare_linux_r2
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          ORIGINAL_FILE="${{ steps.package_deb.outputs.deb-name }}"
          TARGET_DIR="r2_upload"
          TARGET_FILE="teaserpaste-cli-latest.deb"
          
          mkdir -p $TARGET_DIR
          mv $ORIGINAL_FILE $TARGET_DIR/$TARGET_FILE
          echo "::set-output name=r2_source_dir::$TARGET_DIR"
          
      - name: Upload 'latest' (Linux) lên R2
        if: matrix.os == 'ubuntu-latest'
        uses: ryand56/r2-upload-action@v1.4
        with:
          r2-account-id: ${{ secrets.R2_ACCOUNT_ID }}
          r2-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID }}
          r2-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          r2-bucket: ${{ secrets.R2_BUCKET_NAME }}
          source-dir: ${{ steps.prepare_linux_r2.outputs.r2_source_dir }}
          destination-dir: /

      # --- UPLOAD VÀ ĐỔI TÊN THÀNH 'LATEST' CHO MACOS ---
      - name: Chuẩn bị file macOS cho R2
        id: prepare_macos_r2
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          ORIGINAL_FILE="${{ steps.package_dmg.outputs.dmg-name }}"
          TARGET_DIR="r2_upload"
          TARGET_FILE="teaserpaste-cli-latest.dmg"
          
          mkdir -p $TARGET_DIR
          mv $ORIGINAL_FILE $TARGET_DIR/$TARGET_FILE
          echo "::set-output name=r2_source_dir::$TARGET_DIR"
          
      - name: Upload 'latest' (macOS) lên R2
        if: matrix.os == 'macos-latest'
        uses: ryand56/r2-upload-action@v1.4
        with:
          r2-account-id: ${{ secrets.R2_ACCOUNT_ID }}
          r2-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID }}
          r2-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          r2-bucket: ${{ secrets.R2_BUCKET_NAME }}
          source-dir: ${{ steps.prepare_macos_r2.outputs.r2_source_dir }}
          destination-dir: /
